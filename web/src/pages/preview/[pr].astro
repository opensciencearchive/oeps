---
import { Octokit } from '@octokit/rest';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import OEPArticle from '../../components/OEPArticle.astro';

// SSR mode - render on demand
export const prerender = false;

const { pr } = Astro.params;
const prNumber = parseInt(pr || '0', 10);

const octokit = new Octokit({
  auth: import.meta.env.GITHUB_TOKEN,
});

// Parse frontmatter from OEP markdown content
function parseFrontmatter(content: string): Record<string, any> {
  const match = content.match(/^---\n([\s\S]*?)\n---/);
  if (!match) return {};

  const result: Record<string, any> = {};
  for (const line of match[1].split('\n')) {
    const m = line.match(/^(\w+):\s*(.*)$/);
    if (m) {
      const [, key, value] = m;
      // Handle labels as comma-separated list
      if (key === 'labels') {
        result[key] = value
          .split(',')
          .map((s: string) => s.trim().replace(/^['"]|['"]$/g, ''))
          .filter((s: string) => s.length > 0);
      } else {
        result[key] = value.replace(/^['"]|['"]$/g, '');
      }
    }
  }
  return result;
}

let oepData: {
  oep: number;
  title: string;
  type: 'technical' | 'process' | 'informational';
  status: 'ideation' | 'discussion' | 'accepted' | 'living' | 'abandoned';
  labels: string[];
  authors: string;
  created: Date;
  body: string;
  discussion?: string;
} | null = null;

let prMeta: {
  user: string;
  html_url: string;
} | null = null;

let error = '';

try {
  // Fetch PR details
  const { data: prInfo } = await octokit.pulls.get({
    owner: 'opensciencearchive',
    repo: 'oeps',
    pull_number: prNumber,
  });

  prMeta = {
    user: prInfo.user?.login ?? 'unknown',
    html_url: prInfo.html_url,
  };

  // Fetch the files changed in the PR to find OEP files
  const { data: files } = await octokit.pulls.listFiles({
    owner: 'opensciencearchive',
    repo: 'oeps',
    pull_number: prNumber,
  });

  // Find the main OEP file (new or modified) - in oeps/ directory
  const oepFile = files.find(
    (file) => /^oeps\/OEP-\d+\.md$/i.test(file.filename) && file.status !== 'removed'
  );

  if (oepFile) {
    // Fetch the raw content from the PR branch
    const { data: fileContent } = await octokit.repos.getContent({
      owner: 'opensciencearchive',
      repo: 'oeps',
      path: oepFile.filename,
      ref: prInfo.head.ref,
    });

    if ('content' in fileContent && fileContent.content) {
      const rawContent = Buffer.from(fileContent.content, 'base64').toString('utf-8');
      const frontmatter = parseFrontmatter(rawContent);

      // Validate required fields
      const missingFields: string[] = [];
      if (!frontmatter.oep) missingFields.push('oep');
      if (!frontmatter.title) missingFields.push('title');
      if (!frontmatter.type) missingFields.push('type');
      if (!frontmatter.status) missingFields.push('status');
      if (!frontmatter.authors) missingFields.push('authors');
      if (!frontmatter.created) missingFields.push('created');

      if (missingFields.length > 0) {
        error = `Missing required frontmatter fields: ${missingFields.join(', ')}`;
      } else {
        // Validate type
        const validTypes = ['technical', 'process', 'informational'];
        if (!validTypes.includes(frontmatter.type)) {
          error = `Invalid type "${frontmatter.type}". Must be one of: ${validTypes.join(', ')}`;
        } else {
          // Validate status
          const validStatuses = ['ideation', 'discussion', 'accepted', 'living', 'abandoned'];
          if (!validStatuses.includes(frontmatter.status)) {
            error = `Invalid status "${frontmatter.status}". Must be one of: ${validStatuses.join(', ')}`;
          } else {
            // Remove frontmatter and get body
            const bodyMatch = rawContent.match(/^---\n[\s\S]*?\n---\n([\s\S]*)$/);
            const body = bodyMatch ? bodyMatch[1] : rawContent;

            oepData = {
              oep: parseInt(frontmatter.oep, 10),
              title: frontmatter.title,
              type: frontmatter.type as 'technical' | 'process' | 'informational',
              status: frontmatter.status as 'ideation' | 'discussion' | 'accepted' | 'living' | 'abandoned',
              labels: frontmatter.labels ?? [],
              authors: frontmatter.authors,
              created: new Date(frontmatter.created),
              body,
              discussion: frontmatter.discussion,
            };
          }
        }
      }
    }
  } else {
    error = 'No OEP file found in this pull request.';
  }
} catch (e) {
  console.error('Error fetching PR:', e);
  error = `Failed to load PR #${prNumber}. It may not exist or the GitHub API rate limit was exceeded.`;
}

// Set cache headers for stale-while-revalidate
Astro.response.headers.set('Cache-Control', 's-maxage=60, stale-while-revalidate');
---

<Layout title={oepData ? `OEP-${String(oepData.oep).padStart(4, '0')}: ${oepData.title}` : `Preview: PR #${prNumber}`}>
  <Header />

  {error ? (
    <main class="error-container">
      <div class="error">
        <h1 class="error-title">Unable to Load Preview</h1>
        <p class="error-message">{error}</p>
        <a href="/" class="error-link">Back to OEPs</a>
      </div>
    </main>
  ) : oepData && prMeta && (
    <OEPArticle
      oep={oepData.oep}
      title={oepData.title}
      type={oepData.type}
      status={oepData.status}
      labels={oepData.labels}
      authors={oepData.authors}
      created={oepData.created}
      body={oepData.body}
      discussion={oepData.discussion}
      previewBanner={{
        prNumber,
        prUrl: prMeta.html_url,
        user: prMeta.user,
      }}
    />
  )}

  <Footer />
</Layout>

<style>
  .error-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 var(--space-6);
  }

  .error {
    padding: var(--space-20) 0;
    text-align: center;
  }

  .error-title {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: 400;
    margin-bottom: var(--space-4);
  }

  .error-message {
    color: var(--color-text-muted);
    margin-bottom: var(--space-8);
  }

  .error-link {
    color: var(--color-accent);
    text-decoration: none;
  }

  .error-link:hover {
    text-decoration: underline;
  }
</style>
