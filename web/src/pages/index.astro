---
// SSR - fetch PRs on each request
export const prerender = false;

import { getCollection } from 'astro:content';
import { Octokit } from '@octokit/rest';
import { Icon } from 'astro-icon/components';
import Layout from '../layouts/Layout.astro';
import Footer from '../components/Footer.astro';

const oeps = await getCollection('oeps');
const sortedOeps = oeps.sort((a, b) => a.data.oep - b.data.oep);

// Categorize merged OEPs by status
const livingOeps = sortedOeps.filter((oep) => oep.data.status === 'living');
const acceptedOeps = sortedOeps.filter((oep) => oep.data.status === 'accepted');

// PR OEPs will be split into ideation and discussion after fetching

const octokit = new Octokit({
  auth: import.meta.env.GITHUB_TOKEN,
});

// Type for PR OEP data (parsed from PR content)
type PROep = {
  number: number;
  oep: number;
  title: string;
  type: string;
  labels: string[];
  authors: string;
  status: string;
  created: Date;
};

// Format date for display
function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });
}

// Parse frontmatter from OEP markdown content
function parseFrontmatter(content: string): Record<string, any> {
  const match = content.match(/^---\n([\s\S]*?)\n---/);
  if (!match) return {};

  const result: Record<string, any> = {};
  for (const line of match[1].split('\n')) {
    const m = line.match(/^(\w+):\s*(.*)$/);
    if (m) {
      const [, key, value] = m;
      // Handle labels as comma-separated list
      if (key === 'labels') {
        result[key] = value
          .split(',')
          .map((s) => s.trim().replace(/^['"]|['"]$/g, ''))
          .filter((s) => s.length > 0);
      } else {
        result[key] = value.replace(/^['"]|['"]$/g, '');
      }
    }
  }
  return result;
}

let openPRs: PROep[] = [];

try {
  const { data: prs } = await octokit.pulls.list({
    owner: 'opensciencearchive',
    repo: 'oeps',
    state: 'open',
  });

  // Fetch OEP content from each PR to get frontmatter
  openPRs = await Promise.all(
    prs.map(async (pr) => {
      try {
        // Get files changed in this PR
        const { data: files } = await octokit.pulls.listFiles({
          owner: 'opensciencearchive',
          repo: 'oeps',
          pull_number: pr.number,
        });

        // Find the OEP file (in oeps/ directory)
        const oepFile = files.find((f) => /^oeps\/OEP-\d+\.md$/i.test(f.filename));

        if (oepFile) {
          // Fetch the file content from the PR branch
          const { data: fileData } = await octokit.repos.getContent({
            owner: 'opensciencearchive',
            repo: 'oeps',
            path: oepFile.filename,
            ref: pr.head.ref,
          });

          if ('content' in fileData && fileData.content) {
            const content = Buffer.from(fileData.content, 'base64').toString('utf-8');
            const frontmatter = parseFrontmatter(content);

            // Validate required fields - skip PR if missing
            if (!frontmatter.oep || !frontmatter.title || !frontmatter.type || !frontmatter.status || !frontmatter.authors || !frontmatter.created) {
              console.warn(`[PR #${pr.number}] Missing required frontmatter fields, skipping`);
              return null;
            }

            // Only include ideation and discussion status PRs
            const status = frontmatter.status.toLowerCase();
            if (status !== 'ideation' && status !== 'discussion') {
              return null;
            }

            // Validate type is one of the allowed values
            const validTypes = ['technical', 'process', 'informational'];
            if (!validTypes.includes(frontmatter.type)) {
              console.warn(`[PR #${pr.number}] Invalid type "${frontmatter.type}", skipping`);
              return null;
            }

            return {
              number: pr.number,
              oep: parseInt(frontmatter.oep, 10),
              title: frontmatter.title,
              type: frontmatter.type,
              labels: frontmatter.labels ?? [],
              authors: frontmatter.authors.split('<')[0].trim(),
              status,
              created: new Date(frontmatter.created),
            };
          }
        }
      } catch (e) {
        // Fall back to PR data if we can't fetch content
      }

      // Fallback: skip PRs we can't parse
      return null;
    })
  );

  // Filter out nulls
  openPRs = openPRs.filter((pr): pr is PROep => pr !== null);
} catch (error) {
  console.error('Error fetching PRs:', error);
  // Leave openPRs empty on error
}

// Split PRs by status
const ideationPRs = openPRs.filter((pr) => pr.status === 'ideation');
const discussionPRs = openPRs.filter((pr) => pr.status === 'discussion');

// Cache for 30 seconds, serve stale while revalidating for 60 seconds
Astro.response.headers.set('Cache-Control', 'public, s-maxage=30, stale-while-revalidate=60');
---

<Layout title="OEPs — OSA Enhancement Proposals">
  <main class="main">
    <div class="hero-watermark">
      <Icon name="lucide:git-merge" />
    </div>
    <!-- Hero Header -->
    <header class="hero">
      <h1 class="hero-title">
        <span class="hero-title-line">Open</span>
        <span class="hero-title-line hero-title-accent">Science</span>
        <span class="hero-title-line">Archive</span>
      </h1>
      <p class="hero-eyebrow">Enhancement Proposals</p>
      <p class="hero-subtitle">
        The governance process for the OSA protocol. Propose changes, discuss ideas, collaborate. Learn more in <a href="/oep/oep-0001">OEP-0001</a>.
      </p>
      <a href="https://github.com/opensciencearchive/oeps" class="hero-cta" target="_blank" rel="noopener">
        Submit a proposal on GitHub →
      </a>
    </header>

    <!-- Filters and List -->
    <section class="proposals">
      <div class="list-header">
        <h2 class="list-title">All Proposals</h2>
        <div class="filters">
          <span class="filters-label">Filter:</span>
          <div class="filter-buttons">
            <button class="filter-btn filter-ideation" data-status="ideation">
              Ideation <span class="filter-count">{ideationPRs.length}</span>
            </button>
            <button class="filter-btn filter-discussion" data-status="discussion">
              Discussion <span class="filter-count">{discussionPRs.length}</span>
            </button>
            <button class="filter-btn filter-accepted" data-status="accepted">
              Accepted <span class="filter-count">{acceptedOeps.length}</span>
            </button>
            <button class="filter-btn filter-living" data-status="living">
              Living <span class="filter-count">{livingOeps.length}</span>
            </button>
          </div>
        </div>
      </div>

      <ul class="oep-list">
        {/* Ideation PRs */}
        {ideationPRs.map((pr) => (
          <li data-status="ideation">
            <a href={`/preview/${pr.number}`} class="oep-card">
              <div class="oep-card-badges">
                <span class="status-badge status-ideation">ideation</span>
                <span class="oep-type">{pr.type}</span>
              </div>
              <div class="oep-card-content">
                <span class="oep-num">OEP-{String(pr.oep).padStart(4, '0')}</span>
                <span class="oep-title">{pr.title}</span>
                <span class="oep-date">{formatDate(pr.created)}</span>
              </div>
            </a>
          </li>
        ))}
        {/* Discussion PRs */}
        {discussionPRs.map((pr) => (
          <li data-status="discussion">
            <a href={`/preview/${pr.number}`} class="oep-card">
              <div class="oep-card-badges">
                <span class="status-badge status-discussion">discussion</span>
                <span class="oep-type">{pr.type}</span>
              </div>
              <div class="oep-card-content">
                <span class="oep-num">OEP-{String(pr.oep).padStart(4, '0')}</span>
                <span class="oep-title">{pr.title}</span>
                <span class="oep-date">{formatDate(pr.created)}</span>
              </div>
            </a>
          </li>
        ))}
        {/* Accepted OEPs */}
        {acceptedOeps.map((oep) => (
          <li data-status="accepted">
            <a href={`/oep/${oep.id}`} class="oep-card">
              <div class="oep-card-badges">
                <span class="status-badge status-accepted">accepted</span>
                <span class="oep-type">{oep.data.type}</span>
              </div>
              <div class="oep-card-content">
                <span class="oep-num">OEP-{String(oep.data.oep).padStart(4, '0')}</span>
                <span class="oep-title">{oep.data.title}</span>
                <span class="oep-date">{formatDate(oep.data.created)}</span>
              </div>
            </a>
          </li>
        ))}
        {/* Living OEPs */}
        {livingOeps.map((oep) => (
          <li data-status="living">
            <a href={`/oep/${oep.id}`} class="oep-card">
              <div class="oep-card-badges">
                <span class="status-badge status-living">living</span>
                <span class="oep-type">{oep.data.type}</span>
              </div>
              <div class="oep-card-content">
                <span class="oep-num">OEP-{String(oep.data.oep).padStart(4, '0')}</span>
                <span class="oep-title">{oep.data.title}</span>
                <span class="oep-date">{formatDate(oep.data.created)}</span>
              </div>
            </a>
          </li>
        ))}
      </ul>

      <p class="empty-state" id="empty-message" style="display: none;">
        No OEPs match the selected filters.
      </p>
    </section>
  </main>

  <Footer />
</Layout>

<script>
  const filterBtns = document.querySelectorAll('.filter-btn');
  const oepItems = document.querySelectorAll('.oep-list li[data-status]');
  const emptyMessage = document.getElementById('empty-message');

  function updateVisibility() {
    const activeStatuses = new Set<string>();
    filterBtns.forEach((btn) => {
      if (btn.classList.contains('active')) {
        activeStatuses.add(btn.getAttribute('data-status')!);
      }
    });

    // If no filters active, show everything
    const showAll = activeStatuses.size === 0;

    let visibleCount = 0;
    oepItems.forEach((item) => {
      const status = item.getAttribute('data-status');
      if (showAll || (status && activeStatuses.has(status))) {
        (item as HTMLElement).style.display = '';
        visibleCount++;
      } else {
        (item as HTMLElement).style.display = 'none';
      }
    });

    // Show empty message if no items visible
    if (emptyMessage) {
      emptyMessage.style.display = visibleCount === 0 ? 'block' : 'none';
    }
  }

  filterBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      btn.classList.toggle('active');
      updateVisibility();
    });
  });
</script>

<style>
  .main {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--space-6) var(--space-20);
    box-sizing: border-box;
    position: relative;
  }

  .hero-watermark {
    position: absolute;
    left: -12.5%;
    top: 20%;
    /* transform: rotate(180deg); */
    /* transform: translateY(-70%) rotate(0deg); */
    width: clamp(270px, 36vw, 450px);
    height: clamp(270px, 36vw, 450px);
    color: var(--color-text);
    opacity: 0.03;
    pointer-events: none;
  }

  .hero-watermark svg {
    width: 100%;
    height: 100%;
    stroke-width: 0.5;
  }

  /* Hero Header */
  .hero {
    position: relative;
    padding: var(--space-40) 0 var(--space-40);
    max-width: 500px;
    margin-left: auto;
    margin-right: var(--space-32);
    text-align: right;
  }

  .hero-title {
    font-family: var(--font-display);
    font-size: clamp(2.5rem, 8vw, 4rem);
    font-weight: 400;
    line-height: 1.1;
    letter-spacing: -0.02em;
    margin-bottom: var(--space-4);
  }

  .hero-eyebrow {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: 400;
    letter-spacing: -0.01em;
    color: var(--color-text-muted);
    margin-bottom: var(--space-8);
  }

  .hero-title-line {
    display: block;
  }

  .hero-title-accent {
    color: var(--color-accent);
  }

  .hero-subtitle {
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    color: var(--color-text-muted);
    margin-bottom: var(--space-8);
    max-width: 420px;
    margin-left: auto;
  }

  .hero-subtitle a {
    color: var(--color-text);
    text-decoration: underline;
    text-underline-offset: 2px;
    text-decoration-color: var(--color-border);
    transition: text-decoration-color var(--transition-fast);
  }

  .hero-subtitle a:hover {
    text-decoration-color: var(--color-text);
  }

  .hero-cta {
    display: inline-block;
    font-size: var(--text-base);
    font-weight: 500;
    color: var(--color-text);
    text-decoration: none;
    padding-bottom: var(--space-2);
    border-bottom: 2px solid var(--color-text);
    transition: all var(--transition-fast);
  }

  .hero-cta:hover {
    color: var(--color-accent-hover);
    border-color: var(--color-accent-hover);
  }

  /* Proposals - now primary content */
  .proposals {
    margin-top: 0;
    width: 100%;
  }

  /* List Header */
  .list-header {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding: var(--space-8) 0 var(--space-6);
  }

  .list-title {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: 400;
    letter-spacing: var(--tracking-tight);
    color: var(--color-text);
    margin: 0;
  }

  /* Filters */
  .filters {
    display: flex;
    align-items: center;
    gap: var(--space-3);
  }

  .filters-label {
    font-size: var(--text-xs);
    color: var(--color-text-subtle);
  }

  .filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  @media (max-width: 1500px) {
    .hero-watermark {
      left: 0%;
    }
  }

  @media (max-width: 900px) {
    .hero-watermark {
      display: none;
    }
  }

  @media (max-width: 640px) {
    .hero {
      padding: var(--space-16) 0 var(--space-8);
      margin-left: 0;
      margin-right: 0;
      text-align: left;
    }

    .hero-subtitle {
      margin-left: 0;
    }

    .filters {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-2);
    }
  }

  .filter-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 500;
    padding: var(--space-2) var(--space-3);
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all 150ms ease;
    opacity: 0.5;
  }

  .filter-btn.active {
    opacity: 1;
  }

  .filter-count {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    opacity: 0.7;
  }

  /* Filter button colors matching status badges */
  .filter-btn.filter-ideation {
    background: hsl(270, 45%, 93%);
    color: hsl(270, 50%, 40%);
  }

  .filter-btn.filter-ideation.active {
    border-color: hsl(270, 45%, 75%);
  }

  .filter-btn.filter-discussion {
    background: hsl(40, 80%, 92%);
    color: hsl(35, 80%, 30%);
  }

  .filter-btn.filter-discussion.active {
    border-color: hsl(40, 70%, 70%);
  }

  .filter-btn.filter-accepted {
    background: hsl(160, 35%, 90%);
    color: hsl(160, 40%, 32%);
  }

  .filter-btn.filter-accepted.active {
    border-color: hsl(160, 35%, 70%);
  }

  .filter-btn.filter-living {
    background: hsl(210, 50%, 92%);
    color: hsl(210, 50%, 35%);
  }

  .filter-btn.filter-living.active {
    border-color: hsl(210, 45%, 75%);
  }

  /* OEP List */
  .oep-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  /* Card - Mobile first (stacked layout) */
  .oep-card {
    display: block;
    padding: var(--space-5);
    text-decoration: none;
    color: inherit;
    background: var(--color-bg-alt);
    border: 1px solid transparent;
    border-radius: var(--radius-md);
    transition: all 150ms ease;
  }

  .oep-card:hover {
    border-color: var(--color-border);
  }

  .oep-card-badges {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-3);
  }

  /* Status badges on cards */
  .status-badge {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    font-weight: 500;
    text-transform: lowercase;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
  }

  .status-badge.status-ideation {
    color: hsl(270, 50%, 40%);
    background: hsl(270, 45%, 93%);
  }

  .status-badge.status-discussion {
    color: hsl(35, 80%, 30%);
    background: hsl(40, 80%, 92%);
  }

  .status-badge.status-accepted {
    color: hsl(160, 40%, 32%);
    background: hsl(160, 35%, 90%);
  }

  .status-badge.status-living {
    color: hsl(210, 50%, 35%);
    background: hsl(210, 50%, 92%);
  }

  .oep-card-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .oep-num {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text);
  }

  .oep-title {
    font-family: var(--font-body);
    font-size: var(--text-base);
    font-weight: 400;
    color: var(--color-text-muted);
    line-height: var(--leading-normal);
  }

  .oep-date {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-subtle);
    margin-top: var(--space-2);
  }

  .oep-type {
    display: inline-block;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    font-weight: 500;
    text-transform: lowercase;
    letter-spacing: var(--tracking-wider);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    /* Neutral gray for all types */
    color: var(--color-text-muted);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
  }

  /* Desktop: horizontal row layout */
  @media (min-width: 640px) {
    .oep-card {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4) var(--space-5);
    }

    .oep-card-badges {
      order: 2;
      margin: 0;
    }

    .oep-card-content {
      order: 1;
      flex-direction: row;
      align-items: baseline;
      gap: var(--space-4);
    }

    .oep-num {
      flex-shrink: 0;
      width: 85px;
    }

    .oep-title {
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: var(--text-sm);
    }

    .oep-date {
      flex-shrink: 0;
      margin: 0;
    }
  }

  .review-prompt {
    font-size: var(--text-xs);
    color: var(--color-text-subtle);
    margin-bottom: var(--space-2);
  }

  .empty-state {
    padding: var(--space-6) 0;
    font-size: var(--text-sm);
    color: var(--color-text-muted);
  }

  .empty-state a {
    color: var(--color-text);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .empty-state a:hover {
    color: var(--color-accent-hover);
  }

</style>
